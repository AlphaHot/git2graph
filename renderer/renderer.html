<!doctype html>
<html>
  <head>
    <title>Git2Graph Renderer</title>
    <link rel="stylesheet" href="vendors/bootstrap/css/bootstrap.min.css" type="text/css" media="screen" charset="utf-8" />
    <script src="vendors/d3.min.js"></script>
    <script src="vendors/underscore.min.js"></script>
    <script src="vendors/jquery.min.js"></script>
    <script src="vendors/bootstrap/js/bootstrap.min.js"></script>
    <style>
      #json {
        height: 200px;
      }
      #tree {
        border: 1px solid gray;
        height: 200px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Tree renderer</h1>
      <div class="form-group">
        <label>Json:</label>
        <select class="form-control" id="examples">
          <option>Choose an example</option>
          <option value="test1">Test 1</option>
          <option value="test2">Test 2</option>
          <option value="test3">Test 3</option>
          <option value="test4">Test 4</option>
          <option value="test5">Test 5</option>
          <option value="test6">Test 6</option>
        </select>
      </div>
      <div id="json-group" id="json-group" class="form-group">
        <textarea id="json" class="form-control"></textarea>
      </div>
      <div class="form-group">
        <button class="btn btn-success" onclick="render()">Render</button>
      </div>
      <div id="tree-group" class="form-group">
        <label>Result:</label>
        <div>
          <svg id="tree" class="form-control"></svg>
        </div>
      </div>
    </div>
    <script>
      var examples = {};
      examples.test1 = '[{"id":"1","parents":["2"],"column":0,"parents_paths":[{"id":"2","path":[{"x":0,"y":0,"type":0},{"x":0,"y":1,"type":0}]}],"idx":0},{"id":"2","parents":["3"],"column":0,"parents_paths":[{"id":"3","path":[{"x":0,"y":1,"type":0},{"x":0,"y":2,"type":0}]}],"idx":1},{"id":"3","parents":[],"column":0,"parents_paths":[],"idx":2}]';
      examples.test2 = '[{"id":"1","parents":["3"],"column":0,"parents_paths":[{"id":"3","path":[{"x":0,"y":0,"type":0},{"x":0,"y":2,"type":0}]}],"idx":0},{"id":"2","parents":["3"],"column":1,"parents_paths":[{"id":"3","path":[{"x":1,"y":1,"type":0},{"x":1,"y":2,"type":1},{"x":0,"y":2,"type":0}]}],"idx":1},{"id":"3","parents":[],"column":0,"parents_paths":[],"idx":2}]';
      examples.test3 = '[{"id":"1","parents":["3","2"],"column":0,"parents_paths":[{"id":"3","path":[{"x":0,"y":0,"type":0},{"x":0,"y":2,"type":0}]},{"id":"2","path":[{"x":0,"y":0,"type":0},{"x":1,"y":0,"type":2},{"x":1,"y":1,"type":0}]}],"idx":0},{"id":"2","parents":["3"],"column":1,"parents_paths":[{"id":"3","path":[{"x":1,"y":1,"type":0},{"x":1,"y":2,"type":1},{"x":0,"y":2,"type":0}]}],"idx":1},{"id":"3","parents":[],"column":0,"parents_paths":[],"idx":2}]';
      examples.test4 = '[{"id":"1","parents":["3","2"],"column":0,"parents_paths":[{"id":"3","path":[{"x":0,"y":0,"type":0},{"x":0,"y":2,"type":0}]},{"id":"2","path":[{"x":0,"y":0,"type":0},{"x":1,"y":0,"type":2},{"x":1,"y":1,"type":0}]}],"idx":0},{"id":"2","parents":["5"],"column":1,"parents_paths":[{"id":"5","path":[{"x":1,"y":1,"type":0},{"x":1,"y":4,"type":1},{"x":0,"y":4,"type":0}]}],"idx":1},{"id":"3","parents":["5","4"],"column":0,"parents_paths":[{"id":"5","path":[{"x":0,"y":2,"type":0},{"x":0,"y":4,"type":0}]},{"id":"4","path":[{"x":0,"y":2,"type":0},{"x":2,"y":2,"type":2},{"x":2,"y":3,"type":0}]}],"idx":2},{"id":"4","parents":["5"],"column":2,"parents_paths":[{"id":"5","path":[{"x":2,"y":3,"type":0},{"x":2,"y":4,"type":1},{"x":0,"y":4,"type":0}]}],"idx":3},{"id":"5","parents":[],"column":0,"parents_paths":[],"idx":4}]';
      examples.test5 = '[{"id":"1","parents":["4"],"column":0,"parents_paths":[{"id":"4","path":[{"x":0,"y":0,"type":0},{"x":0,"y":3,"type":0}]}],"idx":0},{"id":"2","parents":["4"],"column":1,"parents_paths":[{"id":"4","path":[{"x":1,"y":1,"type":0},{"x":1,"y":3,"type":1},{"x":0,"y":3,"type":0}]}],"idx":1},{"id":"3","parents":["4"],"column":2,"parents_paths":[{"id":"4","path":[{"x":2,"y":2,"type":0},{"x":2,"y":3,"type":1},{"x":0,"y":3,"type":0}]}],"idx":2},{"id":"4","parents":["6"],"column":0,"parents_paths":[{"id":"6","path":[{"x":0,"y":3,"type":0},{"x":0,"y":5,"type":0}]}],"idx":3},{"id":"5","parents":["6"],"column":1,"parents_paths":[{"id":"6","path":[{"x":1,"y":4,"type":0},{"x":1,"y":5,"type":1},{"x":0,"y":5,"type":0}]}],"idx":4},{"id":"6","parents":[],"column":0,"parents_paths":[],"idx":5}]';
      examples.test6 = '[{"id":"1","parents":["3","2"],"column":0,"parents_paths":[{"id":"3","path":[{"x":0,"y":0,"type":0},{"x":0,"y":2,"type":0}]},{"id":"2","path":[{"x":0,"y":0,"type":0},{"x":1,"y":0,"type":2},{"x":1,"y":1,"type":0}]}],"idx":0},{"id":"2","parents":["3","4"],"column":1,"parents_paths":[{"id":"3","path":[{"x":1,"y":1,"type":0},{"x":0,"y":1,"type":3},{"x":0,"y":2,"type":0}]},{"id":"4","path":[{"x":1,"y":1,"type":0},{"x":1,"y":3,"type":0}]}],"idx":1},{"id":"3","parents":["5"],"column":0,"parents_paths":[{"id":"5","path":[{"x":0,"y":2,"type":0},{"x":0,"y":4,"type":0}]}],"idx":2},{"id":"4","parents":["5"],"column":1,"parents_paths":[{"id":"5","path":[{"x":1,"y":3,"type":0},{"x":1,"y":4,"type":1},{"x":0,"y":4,"type":0}]}],"idx":3},{"id":"5","parents":[],"column":0,"parents_paths":[],"idx":4}]';

      $('#examples').change(function() {
        var val = $('#examples').val();
        var text = '';
        if (examples[val]) {
          text = JSON.stringify(JSON.parse(examples[val]), null, 2);
        }
        $('#json').val(text);
        render();
      });

      var render = function() {
        var jsonText = $('#json').val();
        try {
          var tree = JSON.parse(jsonText);
          $("#json-group").removeClass("has-error");
        } catch(err) {
          $("#json-group").addClass("has-error");
        }
        var xGap = 15;
        var yGap = 20;
        var gap = 2 / 5 * yGap;

        var svg = d3.select($('#tree')[0]);
        svg.selectAll('*').remove();
        var sg = svg.append('g')

        var lineFunction = d3.svg.line()
          .x(function(d) { return d.x; })
          .y(function(d) { return d.y; })
          .interpolate("linear");

        var commitGroup = sg.selectAll('commitGroup')
          .data(tree)
          .enter()
          .append('g');

        commitGroup.selectAll('lines')
          .data(function(d) { return d.parents_paths; })
          .enter()
          .append('path')
          .attr('d', function(path) {
            var d = [];
            _.each(path.path, function(node) {
              var point = {x: 5 + node.x * xGap, y: 5 + node.y * yGap};
              switch (node.type) {
                case 1:
                  point.y -= gap;
                  break;
                case 2:
                case 3:
                  point.y += gap;
                  break;
              }
              d.push(point);
            });
            return lineFunction(d);
          })
          .attr('stroke-width', 2)
          .attr('fill', 'none')
          .attr('stroke', '#1f77b4');

        sg.selectAll('commit')
          .data(tree)
          .enter()
          .append('circle')
            .attr('r', 4)
            .attr('fill', '#1f77b4')
            .attr('stroke', 'black')
            .attr('cx', function(commit) { return 5 + commit.column * xGap; })
            .attr('cy', function(commit, idx) { return 5 + idx * yGap; });
      };
    </script>
  </body>
</html>
