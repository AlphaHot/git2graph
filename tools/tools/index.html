<!doctype html>
<html>
  <head>
    <title></title>
    <link rel="stylesheet" href="../vendors/bootstrap/css/bootstrap.min.css" type="text/css" media="screen" charset="utf-8" />
    <link rel="stylesheet" href="../vendors/font-awesome-4.4.0/css/font-awesome.min.css" type="text/css" media="screen" charset="utf-8" />
    <script src="../vendors/d3.min.js"></script>
    <script src="../vendors/lodash.min.js"></script>
    <script src="../vendors/clipboard.min.js"></script>
    <script src="../vendors/jquery.min.js"></script>
    <script src="../vendors/bootstrap/js/bootstrap.min.js"></script>
    <style>
      #tree {
        height: 300px;
        min-height: 300px;
      }
      #out {
        height: 300px;
      }
      #tests {
        height: 300px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1></h1>

      <div class="row">
        <div class="col-sm-4">
          <input type="text" class="form-control" placeholder="Test name" />
        </div>
      </div>

      <div class="row">
        <div class="col-sm-4">
          <label>Svg</label>
          <div class="">
            <button class="btn btn-default" onclick="setMode('commits')"><i class="fa fa-circle"></i></button>
            <button class="btn btn-default" onclick="setMode('links')"><i class="fa fa-share-alt"></i></button>
            <button class="btn btn-default" onclick="btnAddRowClicked()"><i class="fa fa-plus"></i> Add row</button>
            <button class="btn btn-default">Add column</button>
          </div>
          <svg id="tree" class="form-control"></svg>
        </div>
        <div class="col-sm-4">
          <label>Input file</label>
          <button class="copy btn btn-default btn-xs" data-clipboard-target="#out">Copy</button>
          <textarea id="out" class="form-control" readonly></textarea>
        </div>
        <div class="col-sm-4">
          <label>Tests file</label>
          <button class="copy btn btn-default btn-xs" data-clipboard-target="#tests">Copy</button>
          <textarea id="tests" class="form-control" readonly></textarea>
        </div>
      </div>

      <div class="row">
        <div class="col-sm-4">
          <label>Shell script</label>
          <button class="copy btn btn-default btn-xs" data-clipboard-target="#shell">Copy</button>
          <textarea id="shell" class="form-control" readonly></textarea>
        </div>
      </div>

    </div>
    <script>
      new Clipboard('.copy');
      var mode = 'commits';
      var firstCommit = null;

      var setMode = function(modeName) {
        mode = modeName;
        render();
      };

      var tree = [];

      var btnAddRowClicked = function() {
        tree.push({id: tree.length.toString(), parents: []});
        render();
      };


      var lineFunction = d3.svg.line()
        .x(function(d) { return d.x; })
        .y(function(d) { return d.y; })
        .interpolate("linear");


      var render = function() {
        var xGap = 30;
        var yGap = 30;
        var cols = 10;
        var radius = 8;

        var svg = d3.select($('#tree')[0]);
        svg.style('height', (tree.length + 1) * yGap + radius);
        svg.selectAll('*').remove();

        var linesGroup = svg.append('g');

        var lineGroup = linesGroup.selectAll('lines')
          .data(tree)
          .enter()
          .append('g');

        lineGroup
          .append('path')
          .attr('d', function(path, idx) {
            var d = [];
            d.push({x: 0, y: idx * yGap + yGap});
            d.push({x: $('#tree').width(), y: idx * yGap + yGap});
            return lineFunction(d)
          })
          .attr('stroke-width', 1)
          .attr('fill', 'none')
          .attr('stroke', '#aaa')
          .on('click', function(a, row, c) {
            tree.splice(row, 1);
            render();
          });

        lineGroup
          .append('path')
          .attr('d', function(path, idx) {
            var d = [];
            _.each(path.parents, function(parentId) {
              var p = tree[parentId];
              d.push({x: path.column * xGap + xGap, y: path.id * yGap + yGap});
              // TODO: Add middle points
              d.push({x: p.column * xGap + xGap, y: p.id * yGap + yGap});
            });
            return lineFunction(d)
          })
          .attr('stroke-width', 2)
          .attr('fill', 'none')
          .attr('stroke', '#5aa1be')
          .on('click', function(obj, row, c) {
            tree[obj.id].parents = [];
            render();
            console.log(obj, row, c);
          });

        if (mode == 'commits') {
          lineGroup.selectAll('dummyCircle')
            .data(function(d, i) { return _.range(cols); })
            .enter()
            .append('circle')
              .attr('r', radius)
              .attr('fill', 'none')
              .attr('stroke', function(a,b,c) {
                if (tree[c].column == a) {
                  return '#000';
                }
                return '#ddd';
              })
              .attr('fill', function(a,b,c) {
                if (tree[c].column == a) {
                  return '#0f0';
                }
                return '#fff';
              })
              .attr('cx', function(c) {
                return c * xGap + xGap;
              })
              .attr('cy', function(c, i, a) { return a * yGap + yGap })
              .on('mouseenter', function() {
                d3.select(this).attr('fill', '#f00');
              })
              .on('mouseleave', function(a,b,c) {
                d3.select(this).attr('fill', function() {
                  return tree[c].column == a ? '#0f0' : '#fff' ;
                });
              })
              .on('click', function(a,b,c) {
                tree[c].column = a;
                render();
              });
        } else {
          lineGroup.selectAll('dummyCircle')
            .data(function(d, i) { return _.range(cols); })
            .enter()
            .append('circle')
              .attr('r', function(a,b,c) {
                if (tree[c].column == a) {
                  return radius;
                } else {
                  return 3;
                }
              })
              .attr('fill', 'none')
              .attr('stroke', function(a,b,c) {
                if (tree[c].column == a) {
                  return '#000';
                }
                return '#ddd';
              })
              .attr('fill', function(a,b,c) {
                if (tree[c].column == a) {
                  return '#0f0';
                }
                return '#aaa';
              })
              .attr('cx', function(c) {
                return c * xGap + xGap;
              })
              .attr('cy', function(c, i, a) { return a * yGap + yGap })
              .on('mousedown', function(a,b,c) {
                firstCommit = c;
              })
              .on('mouseup', function(colIndex, colIndex, rowIndex) {
                if (tree[rowIndex].column != colIndex) {
                  console.log('...CALISS');
                }
                if (firstCommit == rowIndex) {
                  return;
                }
                if (firstCommit > rowIndex) {
                  firstCommit = [rowIndex, rowIndex = firstCommit][0]; // swap vars
                }
                if (!_.includes(tree[firstCommit].parents, rowIndex)) {
                  tree[firstCommit].parents.push(rowIndex.toString());
                  render();
                }
              });
        }

        generateTestsFile();
        generateShellScript();

        var output = _.map(tree, function(el) { return _.pick(el, ['id', 'parents']); });
        $('#out').val(JSON.stringify(output, null, 2));
      };

      var generateTestsFile = function() {
        var testName = 'Test1';
        var out = '';
        out += 'func ' + testName + '(t *testing.T) {\n';

        out += '	// Initial input\n';
        out += '	inputNodes := make([]map[string]interface{}, 0)\n';
        _.each(tree, function(node) {
          var p = _.map(node.parents, function(el) { return '"' + el + '"'; }).join(',');
          out += '	inputNodes = append(inputNodes, map[string]interface{}{"id": "' + node.id + '", "parents": []string{' + p + '}})\n';
        });

        out += '\n	out, _ := buildTree(inputNodes, customColors)\n\n';

        out += '	// Expected output\n';
        var expectedColumns = _.map(tree, 'column').join(', ');
        out += '	expectedColumns := []int{' + expectedColumns + '}\n\n';

        out += '	expectedPaths := []map[string]Path{\n';
        _.each(tree, function(node) {
          out += '		map[string]Path{\n';
          _.each(node.parents, function(parentId) {
            var parentNode = tree[parentId];
            out += '			"' + parentId + '": Path{"' + parentId + '", []Point{Point{' + node.column + ', ' + node.id + ', 0}, Point{' + parentNode.column + ', ' + parentNode.id + ', 0}}, "nocolor"},\n';
          });
          out += '		},\n';
        });
        out += '	}\n\n';

        out += '	// Validation\n';
        out += '	validateColumns(t, expectedColumns, out)\n';
        out += '	validatePaths(t, expectedPaths, out)\n';
        out += '	validateColors(t, expectedPaths, out)\n';
        out += '}';

        $('#tests').val(out);
      };


      var generateShellScript = function() {

        var createCommit = function(id) {
          var out = '';
          out += 'touch ' + id + '\n';
          out += 'git add ' + id + '\n';
          out += 'git commit -m ' + id + '\n';
          return out;
        };

        var reversedNodes = _.cloneDeep(tree);
        _.reverse(reversedNodes);
        var out = "";
        _.each(reversedNodes, function(item, idx) {
          if (item.parents.length == 0) {
            out += 'git checkout -b ' + item.id + '\n';
            out += createCommit(item.id);
          } else if (item.parents.length == 1) {
            if (tree[item.parents[0]].column < item.column) {
              out += 'git checkout ' + item.parents[0] + '\n';
              out += 'git checkout -b ' + item.id + '\n';
              out += createCommit(item.id);
            } else if (tree[item.parents[0]].column == item.column) {
              out += 'git checkout ' + item.parents[0] + '\n';
              out += 'git checkout -b ' + item.id + '\n';
              out += createCommit(item.id);
            }
          } else if (item.parents.length == 2) {
            if (tree[item.parents[0]].column < item.column) {
              out += 'git checkout ' + item.parents[1] + '\n';
              out += 'git checkout -b ' + item.id + '\n';
              out += 'git merge -m ' + item.parents[0] + ' --no-ff ' + item.parents[0] + '\n';
            } else if (tree[item.parents[1]].column > item.column) {
              out += 'git checkout ' + item.parents[0] + '\n';
              out += 'git checkout -b ' + item.id + '\n';
              out += 'git merge -m ' + item.parents[1] + ' --no-ff ' + item.parents[1] + '\n';
            }
          }
        });
        $('#shell').val(out);
      };


      render();
    </script>
  </body>
</html>
